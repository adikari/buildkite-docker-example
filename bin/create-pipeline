#!/bin/bash

CURRENT_DIR=$(pwd)
ROOT_DIR="$( dirname "${BASH_SOURCE[0]}" )"/..
PIPELINE=$1

cd $ROOT_DIR

[ -z "$PIPELINE" ] && { echo "pipeline missing in argument"; exit; }
[ ! -f "$PIPELINE" ] && { echo "pipeline config not found"; exit; }

echo "Creating pipeline $PIPELINE"
RESPONSE=$(curl -s POST "https://api.buildkite.com/v2/organizations/$ORG_SLUG/pipelines" \
  -H "Authorization: Bearer $BUILDKITE_TOKEN" \
  -d @$PIPELINE)

echo $RESPONSE | jq .
echo "Pipeline create complete."

echo "Webhook Url: $(echo "$RESPONSE" | jq -r '.provider.webhook_url')"

cd $CURRENT_DIR
